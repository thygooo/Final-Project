{% extends 'clinic/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Request Medicine{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h3 class="card-title">
                    <i class="bi bi-cart-plus"></i> Request Medicine
                </h3>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'inventory' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Submit Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4><i class="bi bi-info-circle"></i> Available Medicines</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Medicine</th>
                                <th>Category</th>
                                <th>Shelf</th>
                                <th>Available Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for medicine in available_medicines %}
                            <tr>
                                <td>{{ medicine.name }}</td>
                                <td>{{ medicine.category.name }}</td>
                                <td>{{ medicine.shelf_location }}</td>
                                <td class="fw-bold">{{ medicine.quantity }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No medicines currently available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<script>
$(document).ready(function() {
    // Initialize Select2 for medicine dropdown
    $('#id_medicine').select2({
        placeholder: "Select a medicine",
        allowClear: true,
        width: '100%'
    });

    // Highlight low stock in available medicines table
    $('.table td.fw-bold').each(function() {
        const quantity = parseInt($(this).text());
        if (quantity < 10) {  // Adjust threshold as needed
            $(this).addClass('text-danger');
            $(this).closest('tr').addClass('table-warning');
        }
    });
});
</script>
{% endblock %}